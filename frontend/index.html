<!-- ... head 和 style 省略，body 內容如下 ... -->
<body>
  <div class="container">
    <div class="toolbar">
      <div>
        <span class="filter">篩選標籤：
          <select id="tagFilter"><option value="">全部</option></select>
        </span>
      </div>
      <button class="add-btn" id="addPatientBtn">＋新增病患</button>
    </div>
    <div id="cardList" class="card-list"></div>
  </div>
  <!-- 新增病患對話框 -->
  <div id="addPatientDialog" style="display:none; position:fixed;left:0;top:0;width:100vw;height:100vh;background:#0005;z-index:999;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:26px 34px;border-radius:16px;max-width:300px;min-width:200px;">
      <h4 style="margin-top:0;">新增病患</h4>
      <div style="margin-bottom:8px;">暱稱 <input type="text" id="npNickname" style="width:100%;"></div>
      <div style="margin-bottom:8px;">診斷 <input type="text" id="npDiagnosis" style="width:100%;"></div>
      <div style="margin-bottom:8px;">標籤 <input type="text" id="npTags" placeholder="以逗號分隔" style="width:100%;"></div>
      <button onclick="saveNewPatient()">新增</button>
      <button onclick="hideAddPatient()">取消</button>
    </div>
  </div>
  <script>
    let patients = [];
    async function loadPatients() {
      const res = await fetch('/api/patients');
      patients = await res.json();
      renderTagOptions();
      renderPatients();
    }

    function getAllTags() {
      const allTags = new Set();
      patients.forEach(p => (p.tags||[]).forEach(tag => allTags.add(tag)));
      return Array.from(allTags);
    }

    function renderTagOptions() {
      const tagFilter = document.getElementById('tagFilter');
      const allTags = getAllTags();
      tagFilter.innerHTML = '<option value="">全部</option>' +
        allTags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
    }

    function renderPatients() {
      const tag = document.getElementById('tagFilter').value;
      const list = tag ? patients.filter(p => (p.tags||[]).includes(tag)) : patients;
      document.getElementById('cardList').innerHTML =
        list.map(p => `
        <div class="patient-card">
          <img class="avatar" src="${p.avatar || 'https://api.dicebear.com/7.x/thumbs/svg?seed='+encodeURIComponent(p.nickname)}" alt="avatar">
          <div class="nickname">${p.nickname}</div>
          <div class="diagnosis">${p.diagnosis || ''}</div>
          <div class="tags">${(p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
          <a class="more-link" href="patient.html?pid=${p.id}">更多...</a>
        </div>
        `).join('');
    }

    document.getElementById('tagFilter').addEventListener('change', renderPatients);

    function showAddPatient() {
      document.getElementById('addPatientDialog').style.display = 'flex';
      document.getElementById('npNickname').value = '';
      document.getElementById('npDiagnosis').value = '';
      document.getElementById('npTags').value = '';
    }
    function hideAddPatient() {
      document.getElementById('addPatientDialog').style.display = 'none';
    }
    async function saveNewPatient() {
      const nickname = document.getElementById('npNickname').value.trim();
      const diagnosis = document.getElementById('npDiagnosis').value.trim();
      const tags = document.getElementById('npTags').value.split(',').map(t=>t.trim()).filter(Boolean);
      if (!nickname) { alert('請輸入暱稱'); return; }
      const newPatient = { nickname, diagnosis, tags, avatar: "" };
      await fetch('/api/patients', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newPatient)
      });
      hideAddPatient();
      loadPatients();
    }

    document.getElementById('addPatientBtn').onclick = showAddPatient;
    loadPatients();
  </script>
</body>
